<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Duy·ªát b√†i</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Dashboard duy·ªát b√†i</h1>
      <nav class="nav">
        <a href="/index.html">üè† Trang ch√≠nh</a>
        <a href="/frontend/admin/profile.html">üë§ Profile</a>
        <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
      </nav>
    </header>

    <main>
      <section class="card">
        <h2>B√†i ch·ªù duy·ªát</h2>
        <p class="hint">C√°c b√†i do h·ªçc sinh g·ª≠i l√™n v·ªõi tr·∫°ng th√°i <b>pending</b>.</p>

        <div id="emptyState" class="empty" style="display:none;">
          Hi·ªán ch∆∞a c√≥ b√†i n√†o ch·ªù duy·ªát.
        </div>

        <table id="postsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Ti√™u ƒë·ªÅ</th>
              <th>Lo·∫°i</th>
              <th>Ng∆∞·ªùi g·ª≠i</th>
              <th>Ng√†y g·ª≠i</th>
              <th>Link/·∫¢nh</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="postsBody">
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('authToken');
    const role  = localStorage.getItem('authRole');

    if (!token || role !== 'admin') {
      window.location.href = '/index.html';
    }

    async function loadPendingPosts() {
      try {
        const res = await fetch('/api/admin/posts/pending', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          throw new Error('Response not ok');
        }

        const data = await res.json();
        const tbody = document.getElementById('postsBody');
        const empty = document.getElementById('emptyState');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
          empty.style.display = 'block';
          return;
        } else {
          empty.style.display = 'none';
        }

        data.forEach(post => {
          const tr = document.createElement('tr');

          const createdAt = post.CreatedAt
            ? new Date(post.CreatedAt).toLocaleString('vi-VN')
            : '';

          tr.innerHTML = `
            <td>${post.PostId}</td>
            <td>${post.Title}</td>
            <td>${post.Type}</td>
            <td>${post.CreatedBy || ''}</td>
            <td>${createdAt}</td>
            <td>
              ${post.LinkOrImage 
                ? `<a href="${post.LinkOrImage}" target="_blank" rel="noopener noreferrer">M·ªü</a>`
                : ''}
            </td>
            <td>
              <button class="approve-btn" data-id="${post.PostId}">Duy·ªát</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

        // G√°n s·ª± ki·ªán cho c√°c n√∫t Duy·ªát
        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            if (!confirm('Duy·ªát b√†i #' + id + ' ?')) return;
            await approvePost(id);
          });
        });

      } catch (err) {
        console.error(err);
        alert('L·ªói t·∫£i danh s√°ch b√†i pending');
      }
    }

    async function approvePost(id) {
      try {
        const res = await fetch('/api/admin/posts/' + id + '/approve', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.error || 'L·ªói duy·ªát b√†i');
        }

        // reload danh s√°ch
        await loadPendingPosts();
        alert('Duy·ªát b√†i th√†nh c√¥ng');
      } catch (err) {
        console.error(err);
        alert(err.message || 'L·ªói duy·ªát b√†i');
      }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('authToken');
      localStorage.removeItem('authRole');
      window.location.href = '/index.html';
    });

    loadPendingPosts();
  </script>
</body>
</html>
